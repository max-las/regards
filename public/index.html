<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset='utf-8'>
	<meta name="viewport" content="height=device-height, width=device-width, initial-scale=1, viewport-fit=cover">

	<title>Regards</title>

	<link rel='icon' type='image/png' href='/favicon.png'>
	<link rel='stylesheet' href='/build/bundle.css'>
	<link rel="icon" type="image/png" href="img/deco/favicon.png">

	<script defer src='/build/bundle.js'></script>

	<style>
		.preloadProgress {
			width: 100vw;
			height: 100vh;
			background-color: black;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.preloadProgress p {
			color: white;
			font-size: 40px;
		}

		.hidden {
			display: none;
		}
	</style>
</head>
<body>
	<div class="preloadProgress">
		<p>0%</p>
	</div>

	<div id="svelte" class="hidden"></div>
	
	<script>
		const assets = {
			characters: [
				"Andre.png",
				"Barbegrisebandeau.png",
				"barbegriseprofil.png",
				"Camille.png",
				"Dameauxperles.png",
				"FemmeDenudÃ©e.png",
				"FemmeLouche.png",
				"Femmevoilerose.png",
				"garde.png",
				"Hommeauchapeau.png",
				"HommeDuFond.png",
				"HommeLouche.png",
				"Hommeorange.png",
				"Hommeturbanfond.png",
				"Jesus.png",
				"Leo.png",
				"Intervenante_fondue.png"
			],
			pictures: [
				"Enfants_2.png",
				"christ.png",
				"framed.png",
				"Intervenante.png",
				"museum_outside.jpg"
			],
			deco: [
				"cadre_decors.png",
				"refresh-ccw.svg",
				"casque.png",
				"creditsLeft.svg",
				"creditsRight.svg",
				"backArrow.svg",
				"mmi.svg"
			],
			audio: [
			 	"1_-_Menu_-_click_(touche_clavier).mp3",
				"1_-_Menu_-_musique.mp3",
				"2_-_Musee_exterieur_-_ambiance_de_fond.mp3",
				"2_-_Musee_exterieur_-_musique.mp3",
				"3_-_Musee_-_ambiance_de_fond.mp3",
				"3_-_Musee_-_andre.mp3",
				"3_-_Musee_-_camille.mp3",
				"3_-_Musee_-_leo.mp3",
				"4_-_Fin_-_citation_-_musique.mp3",
				"4_-_Fin_-_sequence_intervenante_-_musique.mp3",
			]
		};
		let assetsCount = assets.characters.length + assets.pictures.length + assets.deco.length;
		let assetsLoaded = 0;
		let percent = 0;
		function runPreloadProgress(){
			for (const picFile of assets.pictures) {
				preloadWithProgress(`/img/pictures/${picFile}`);
			}
			for (const iconFile of assets.characters) {
				preloadWithProgress(`/img/characters/${iconFile}`);
			}
			for (const imgFile of assets.deco) {
				preloadWithProgress(`/img/deco/${imgFile}`);
			}
			for (const audioFile of assets.audio) {
				preloadWithProgress(`/audio/${audioFile}`);
			}
		}
		function preloadWithProgress(url){
			let xhr = new XMLHttpRequest();
			let previousLoad = 0;
			xhr.onprogress = (e) => {
				if(e.total > 0){
					const newLoad = e.loaded / e.total;
					assetsLoaded += newLoad - previousLoad;
					previousLoad = newLoad;
					updatePercent();
				}else{
					console.log(url);
					assetsLoaded += 1 - previousLoad;
				}
			};
			xhr.onload = () => {
				if(xhr.status >= 400){
					assetsLoaded += 1 - previousLoad;
					updatePercent();
				}
			}
			xhr.open("GET", url, true);
			xhr.send();
		}
		function updatePercent(){
			percent = (assetsLoaded / assetsCount) * 100;
			if(percent >= 99.99){
				document.querySelector(".preloadProgress").classList.add("hidden");
				document.querySelector("#svelte").classList.remove("hidden");
			}else{
				document.querySelector(".preloadProgress p").innerHTML = `${Math.floor(percent)}%`;
			}
		}
		runPreloadProgress();
	</script>
</body>
</html>
